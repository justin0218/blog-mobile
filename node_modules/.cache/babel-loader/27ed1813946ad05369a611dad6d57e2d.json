{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nvar _jsxFileName = \"/Users/justin/Desktop/my/client-mobile/pages/chatroom.js\";\nimport _JSXStyle from \"styled-jsx/style\";\nimport React from \"react\";\nimport Layout from '../components/layout';\nimport * as api from '../apis/blog';\nimport pb from \"../proto/ws_pb\";\nimport resp from \"../proto/resp_pb\";\nimport readStream from '../utils/util';\nimport moment from 'moment';\nimport { apiHost } from '../utils/config';\n\nvar _default =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(_default, _React$Component);\n\n  function _default() {\n    var _getPrototypeOf2;\n\n    var _this;\n\n    _classCallCheck(this, _default);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(_default)).call.apply(_getPrototypeOf2, [this].concat(args)));\n\n    _defineProperty(_assertThisInitialized(_this), \"state\", {\n      socket: null,\n      saytext: \"\",\n      msgList: []\n    });\n\n    return _this;\n  }\n\n  _createClass(_default, [{\n    key: \"componentDidMount\",\n    value: function () {\n      var _componentDidMount = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee2() {\n        var _this2 = this;\n\n        var room, socket;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                room = this.props.query.room;\n                socket = this.state.socket;\n                socket = new ReconnectingWebSocket(\"ws://\".concat(apiHost, \"/v1/ws/chatroom?room=\").concat(room));\n                socket.debug = false;\n                socket.timeoutInterval = 5400;\n\n                socket.onopen = function () {//socket.send(\"发送数据\");\n                };\n\n                socket.onmessage =\n                /*#__PURE__*/\n                function () {\n                  var _ref = _asyncToGenerator(\n                  /*#__PURE__*/\n                  _regeneratorRuntime.mark(function _callee(evt) {\n                    var msgList, received_msg, receivedMsg, receivedMsgB, msg, msgObj, _msg, _msgObj, tempMsgList, i, item;\n\n                    return _regeneratorRuntime.wrap(function _callee$(_context) {\n                      while (1) {\n                        switch (_context.prev = _context.next) {\n                          case 0:\n                            msgList = _this2.state.msgList;\n                            received_msg = evt.data;\n                            _context.next = 4;\n                            return readStream(received_msg);\n\n                          case 4:\n                            receivedMsg = _context.sent;\n                            receivedMsgB = pb.ws_msg_base.deserializeBinary(receivedMsg);\n                            _context.t0 = receivedMsgB.getEvent();\n                            _context.next = _context.t0 === pb.events.CHAT_CONTENT ? 9 : _context.t0 === pb.events.CHAT_RECORDS ? 15 : 22;\n                            break;\n\n                          case 9:\n                            console.log(112);\n                            msg = pb.chat_content.deserializeBinary(receivedMsgB.getData());\n                            msgObj = msg.toObject();\n                            msgList.unshift(msgObj);\n                            _this2.setState({\n                              msgList: msgList\n                            }), function () {\n                              console.log(112);\n                              setTimeout(function () {\n                                document.documentElement.scrollTop = 0;\n                              }, 3500);\n                            };\n                            return _context.abrupt(\"break\", 22);\n\n                          case 15:\n                            _msg = resp.blog_chat_records.deserializeBinary(receivedMsgB.getData());\n                            _msgObj = _msg.toObject();\n                            tempMsgList = [];\n\n                            for (i = 0; i < _msgObj.blogChatRecordListList.length; i++) {\n                              item = _msgObj.blogChatRecordListList[i];\n                              tempMsgList.push({\n                                \"timeString\": moment(item.createTime).format(\"YYYY-MM-DD HH:mm:ss\"),\n                                \"msg\": item.content\n                              });\n                            }\n\n                            _this2.setState({\n                              msgList: tempMsgList\n                            });\n\n                            setTimeout(function () {\n                              document.getElementById(\"t\").setAttribute(\"class\", \"shadownone\");\n                              document.getElementById(\"loading\").style.display = \"none\";\n                            }, 500);\n                            return _context.abrupt(\"break\", 22);\n\n                          case 22:\n                          case \"end\":\n                            return _context.stop();\n                        }\n                      }\n                    }, _callee);\n                  }));\n\n                  return function (_x) {\n                    return _ref.apply(this, arguments);\n                  };\n                }();\n\n                socket.onclose = function () {\n                  console.log(\"链接已关闭\");\n                };\n\n                this.setState({\n                  socket: socket\n                });\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function componentDidMount() {\n        return _componentDidMount.apply(this, arguments);\n      }\n\n      return componentDidMount;\n    }()\n  }, {\n    key: \"subMitComment\",\n    value: function () {\n      var _subMitComment = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(event) {\n        var socket, e, saytext, baseMsg, msg;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                socket = this.state.socket;\n                e = event || window.event;\n\n                if (e && e.keyCode == 13) {\n                  //回车键的键值为13\n                  saytext = this.state.saytext;\n                  baseMsg = new pb.ws_msg_base();\n                  msg = new pb.chat_content();\n                  msg.setMsg(saytext);\n                  baseMsg.setData(msg.serializeBinary());\n                  socket.send(baseMsg.serializeBinary());\n                  this.setState({\n                    saytext: \"\"\n                  }, function () {\n                    setTimeout(function () {\n                      document.documentElement.scrollTop = 0;\n                    }, 300);\n                  });\n                }\n\n              case 3:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function subMitComment(_x2) {\n        return _subMitComment.apply(this, arguments);\n      }\n\n      return subMitComment;\n    }()\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this3 = this;\n\n      var _this$state = this.state,\n          saytext = _this$state.saytext,\n          msgList = _this$state.msgList;\n      return React.createElement(Layout, {\n        title: \"\\u804A\\u5929\\u5BA4\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 99\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"jsx-1208715625\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 100\n        },\n        __self: this\n      }, React.createElement(\"input\", {\n        placeholder: \"\\u804A\\u70B9\\u4EC0\\u4E48\\u5427...\",\n        value: saytext,\n        onChange: function onChange(e) {\n          _this3.setState({\n            \"saytext\": e.target.value\n          });\n        },\n        onKeyUp: this.subMitComment.bind(this),\n        className: \"jsx-1208715625\" + \" \" + \"chatcontent\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 101\n        },\n        __self: this\n      }), React.createElement(\"ul\", {\n        style: {\n          listStyle: \"none\"\n        },\n        className: \"jsx-1208715625\" + \" \" + \"chatlist\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 104\n        },\n        __self: this\n      }, msgList.map(function (item, k) {\n        return React.createElement(\"li\", {\n          key: k,\n          className: \"jsx-1208715625\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 107\n          },\n          __self: this\n        }, React.createElement(\"span\", {\n          className: \"jsx-1208715625\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 108\n          },\n          __self: this\n        }, item.timeString), React.createElement(\"div\", {\n          style: {\n            height: 12\n          },\n          className: \"jsx-1208715625\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 109\n          },\n          __self: this\n        }), React.createElement(\"div\", {\n          className: \"jsx-1208715625\" + \" \" + \"chatbox\",\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 110\n          },\n          __self: this\n        }, item.msg));\n      }))), React.createElement(_JSXStyle, {\n        id: \"1208715625\",\n        __self: this\n      }, \".chatbox.jsx-1208715625{color:#333;border-radius:5px;}.chatlist.jsx-1208715625{width:94%;margin:auto;}.chatlist.jsx-1208715625 li.jsx-1208715625{background:#fff;box-shadow:3px 4px 4px #ccc;border-radius:5px;padding:15px;margin-bottom:20px;}.chatlist.jsx-1208715625 li.jsx-1208715625 span.jsx-1208715625{font-size:14px;}.chatcontent.jsx-1208715625{width:90%;color:#333;font-size:18px;padding:10px 0px;border:none;background:none;margin:auto;display:block;}.chatcontent.jsx-1208715625:hover{outline:none;}.chatcontent.jsx-1208715625:focus{outline:none;}\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qdXN0aW4vRGVza3RvcC9teS9jbGllbnQtbW9iaWxlL3BhZ2VzL2NoYXRyb29tLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQW1Ib0IsQUFHd0IsQUFJRCxBQUlNLEFBT0QsQUFHTCxBQVVHLEFBR0EsVUExQkQsQUFjRCxDQWxCTyxFQTRCcEIsQUFHQSxFQWhCQSxDQVA4QixLQVdiLENBZGpCLE9BSkEsT0FtQm1CLFFBWEMsU0FZTixTQVhDLEdBWUcsVUFYRyxNQVlQLFlBQ0UsQ0FaaEIsYUFhQSIsImZpbGUiOiIvVXNlcnMvanVzdGluL0Rlc2t0b3AvbXkvY2xpZW50LW1vYmlsZS9wYWdlcy9jaGF0cm9vbS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMYXlvdXQgZnJvbSAnLi4vY29tcG9uZW50cy9sYXlvdXQnO1xuaW1wb3J0ICogYXMgYXBpIGZyb20gJy4uL2FwaXMvYmxvZyc7XG5pbXBvcnQgcGIgZnJvbSBcIi4uL3Byb3RvL3dzX3BiXCI7XG5pbXBvcnQgcmVzcCBmcm9tIFwiLi4vcHJvdG8vcmVzcF9wYlwiO1xuaW1wb3J0IHJlYWRTdHJlYW0gZnJvbSAnLi4vdXRpbHMvdXRpbCc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5pbXBvcnQge2FwaUhvc3R9IGZyb20gJy4uL3V0aWxzL2NvbmZpZyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgc3RhdGljIGFzeW5jIGdldEluaXRpYWxQcm9wcyh7IHJlcSxxdWVyeSxqc29uUGFnZVJlcyB9KSB7XG4gICAgY29uc3QgdXNlckFnZW50ID0gcmVxID8gcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSA6IG5hdmlnYXRvci51c2VyQWdlbnRcbiAgICByZXR1cm4geyB1c2VyQWdlbnQscXVlcnksanNvblBhZ2VSZXMgfVxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgc29ja2V0Om51bGwsXG4gICAgc2F5dGV4dDpcIlwiLFxuICAgIG1zZ0xpc3Q6W11cbiAgfVxuXG4gIGFzeW5jIGNvbXBvbmVudERpZE1vdW50KCl7XG4gICAgY29uc3Qge3Jvb219ID0gdGhpcy5wcm9wcy5xdWVyeTtcbiAgICBsZXQge3NvY2tldH0gPSB0aGlzLnN0YXRlO1xuICAgIHNvY2tldCA9IG5ldyBSZWNvbm5lY3RpbmdXZWJTb2NrZXQoYHdzOi8vJHthcGlIb3N0fS92MS93cy9jaGF0cm9vbT9yb29tPSR7cm9vbX1gKTtcbiAgICBzb2NrZXQuZGVidWcgPSBmYWxzZTtcbiAgICBzb2NrZXQudGltZW91dEludGVydmFsID0gNTQwMDtcbiAgICBzb2NrZXQub25vcGVuID0gZnVuY3Rpb24oKXtcbiAgICAgIC8vc29ja2V0LnNlbmQoXCLlj5HpgIHmlbDmja5cIik7XG4gICAgfTtcbiAgICAgICAgXG4gICAgc29ja2V0Lm9ubWVzc2FnZSA9IGFzeW5jIChldnQpID0+XG4gICAgeyBcbiAgICAgIGxldCB7bXNnTGlzdH0gPSB0aGlzLnN0YXRlO1xuICAgICAgdmFyIHJlY2VpdmVkX21zZyA9IGV2dC5kYXRhO1xuICAgICAgbGV0IHJlY2VpdmVkTXNnID0gYXdhaXQgcmVhZFN0cmVhbShyZWNlaXZlZF9tc2cpO1xuICAgICAgbGV0IHJlY2VpdmVkTXNnQiA9IHBiLndzX21zZ19iYXNlLmRlc2VyaWFsaXplQmluYXJ5KHJlY2VpdmVkTXNnKTtcbiAgICAgIHN3aXRjaChyZWNlaXZlZE1zZ0IuZ2V0RXZlbnQoKSl7XG4gICAgICAgIGNhc2UgcGIuZXZlbnRzLkNIQVRfQ09OVEVOVDpcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygxMTIpXG4gICAgICAgICAgICBsZXQgbXNnID0gcGIuY2hhdF9jb250ZW50LmRlc2VyaWFsaXplQmluYXJ5KHJlY2VpdmVkTXNnQi5nZXREYXRhKCkpO1xuICAgICAgICAgICAgbGV0IG1zZ09iaiA9IG1zZy50b09iamVjdCgpO1xuICAgICAgICAgICAgbXNnTGlzdC51bnNoaWZ0KG1zZ09iaik7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHttc2dMaXN0fSksKCk9PntcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coMTEyKVxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wID0gMFxuICAgICAgICAgICAgICB9LCAzNTAwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgY2FzZSBwYi5ldmVudHMuQ0hBVF9SRUNPUkRTOlxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGxldCBtc2cgPSByZXNwLmJsb2dfY2hhdF9yZWNvcmRzLmRlc2VyaWFsaXplQmluYXJ5KHJlY2VpdmVkTXNnQi5nZXREYXRhKCkpO1xuICAgICAgICAgICAgbGV0IG1zZ09iaiA9IG1zZy50b09iamVjdCgpO1xuICAgICAgICAgICAgbGV0IHRlbXBNc2dMaXN0ID0gW107XG4gICAgICAgICAgICBmb3IgKGxldCBpPTA7aTxtc2dPYmouYmxvZ0NoYXRSZWNvcmRMaXN0TGlzdC5sZW5ndGg7aSsrKXtcbiAgICAgICAgICAgICAgbGV0IGl0ZW0gPSBtc2dPYmouYmxvZ0NoYXRSZWNvcmRMaXN0TGlzdFtpXTtcbiAgICAgICAgICAgICAgdGVtcE1zZ0xpc3QucHVzaCh7XCJ0aW1lU3RyaW5nXCI6bW9tZW50KGl0ZW0uY3JlYXRlVGltZSkuZm9ybWF0KFwiWVlZWS1NTS1ERCBISDptbTpzc1wiKSxcIm1zZ1wiOml0ZW0uY29udGVudH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7bXNnTGlzdDogdGVtcE1zZ0xpc3R9KTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0XCIpLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsXCJzaGFkb3dub25lXCIpXG4gICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibG9hZGluZ1wiKS5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgICAgICAgICB9LDUwMClcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgICAgIFxuICAgIHNvY2tldC5vbmNsb3NlID0gZnVuY3Rpb24oKVxuICAgIHsgXG4gICAgICBjb25zb2xlLmxvZyhcIumTvuaOpeW3suWFs+mXrVwiKVxuICAgIH07XG4gICAgdGhpcy5zZXRTdGF0ZSh7c29ja2V0fSk7XG4gIH1cblxuICBhc3luYyBzdWJNaXRDb21tZW50KGV2ZW50KXtcbiAgICBsZXQge3NvY2tldH0gPSB0aGlzLnN0YXRlO1xuICAgIHZhciBlID0gZXZlbnQgfHwgd2luZG93LmV2ZW50O1xuICAgIGlmIChlICYmIGUua2V5Q29kZSA9PSAxMykgeyAvL+Wbnui9pumUrueahOmUruWAvOS4ujEzXG4gICAgICBsZXQge3NheXRleHR9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIGxldCBiYXNlTXNnID0gbmV3IHBiLndzX21zZ19iYXNlKCk7XG4gICAgICBsZXQgbXNnID0gbmV3IHBiLmNoYXRfY29udGVudCgpO1xuICAgICAgbXNnLnNldE1zZyhzYXl0ZXh0KTtcbiAgICAgIGJhc2VNc2cuc2V0RGF0YShtc2cuc2VyaWFsaXplQmluYXJ5KCkpO1xuICAgICAgc29ja2V0LnNlbmQoYmFzZU1zZy5zZXJpYWxpemVCaW5hcnkoKSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHtzYXl0ZXh0OlwiXCJ9LCgpPT57XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgPSAwXG4gICAgICAgIH0sIDMwMCk7XG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBsZXQge3NheXRleHQsbXNnTGlzdH0gPSB0aGlzLnN0YXRlO1xuICAgIHJldHVybiAoXG4gICAgICA8TGF5b3V0IHRpdGxlPXtg6IGK5aSp5a6kYH0+XG4gICAgICAgIDxkaXY+XG4gICAgICAgICAgPGlucHV0IGNsYXNzTmFtZT1cImNoYXRjb250ZW50XCIgcGxhY2Vob2xkZXI9XCLogYrngrnku4DkuYjlkKcuLi5cIiB2YWx1ZT17c2F5dGV4dH0gb25DaGFuZ2U9eyhlKT0+e1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XCJzYXl0ZXh0XCI6ZS50YXJnZXQudmFsdWV9KVxuICAgICAgICAgIH19IG9uS2V5VXA9e3RoaXMuc3ViTWl0Q29tbWVudC5iaW5kKHRoaXMpfSAvPlxuICAgICAgICAgIDx1bCBzdHlsZT17e2xpc3RTdHlsZTpcIm5vbmVcIn19IGNsYXNzTmFtZT1cImNoYXRsaXN0XCI+XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG1zZ0xpc3QubWFwKChpdGVtLGspPT4oXG4gICAgICAgICAgICAgICAgPGxpIGtleT17a30+XG4gICAgICAgICAgICAgICAgICA8c3Bhbj57aXRlbS50aW1lU3RyaW5nfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgIDxkaXYgc3R5bGU9e3toZWlnaHQ6MTJ9fT48L2Rpdj5cbiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiY2hhdGJveFwiPntpdGVtLm1zZ308L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2xpPlxuICAgICAgICAgICAgICApKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIDwvdWw+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8c3R5bGUganN4PntgXG4gICAgICAgICAgLmNoYXRib3h7XG4gICAgICAgICAgICBjb2xvcjogIzMzMztcbiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDVweDtcbiAgICAgICAgICB9XG4gICAgICAgICAgLmNoYXRsaXN0e1xuICAgICAgICAgICAgd2lkdGg6IDk0JTtcbiAgICAgICAgICAgIG1hcmdpbjogYXV0bztcbiAgICAgICAgICB9XG4gICAgICAgICAgLmNoYXRsaXN0IGxpIHtcbiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmY7XG4gICAgICAgICAgICBib3gtc2hhZG93OiAzcHggNHB4IDRweCAjY2NjO1xuICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNXB4O1xuICAgICAgICAgICAgcGFkZGluZzogMTVweDtcbiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDIwcHg7XG4gICAgICAgICAgfVxuICAgICAgICAgIC5jaGF0bGlzdCBsaSBzcGFue1xuICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4O1xuICAgICAgICAgIH1cbiAgICAgICAgICAuY2hhdGNvbnRlbnR7XG4gICAgICAgICAgICB3aWR0aDogOTAlO1xuICAgICAgICAgICAgY29sb3I6ICMzMzM7XG4gICAgICAgICAgICBmb250LXNpemU6IDE4cHg7XG4gICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDBweDtcbiAgICAgICAgICAgIGJvcmRlcjogbm9uZTtcbiAgICAgICAgICAgIGJhY2tncm91bmQ6IG5vbmU7XG4gICAgICAgICAgICBtYXJnaW46IGF1dG87XG4gICAgICAgICAgICBkaXNwbGF5OiBibG9jaztcbiAgICAgICAgICB9XG4gICAgICAgICAgLmNoYXRjb250ZW50OmhvdmVye1xuICAgICAgICAgICAgb3V0bGluZTogbm9uZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLmNoYXRjb250ZW50OmZvY3Vze1xuICAgICAgICAgICAgb3V0bGluZTogbm9uZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgYH08L3N0eWxlPlxuICAgICAgPC9MYXlvdXQ+XG4gICAgKVxuXG4gICBcblxuICB9XG59XG5cblxuIl19 */\\n/*@ sourceURL=/Users/justin/Desktop/my/client-mobile/pages/chatroom.js */\"));\n    }\n  }], [{\n    key: \"getInitialProps\",\n    value: function () {\n      var _getInitialProps = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee4(_ref2) {\n        var req, query, jsonPageRes, userAgent;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                req = _ref2.req, query = _ref2.query, jsonPageRes = _ref2.jsonPageRes;\n                userAgent = req ? req.headers['user-agent'] : navigator.userAgent;\n                return _context4.abrupt(\"return\", {\n                  userAgent: userAgent,\n                  query: query,\n                  jsonPageRes: jsonPageRes\n                });\n\n              case 3:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      function getInitialProps(_x3) {\n        return _getInitialProps.apply(this, arguments);\n      }\n\n      return getInitialProps;\n    }()\n  }]);\n\n  return _default;\n}(React.Component);\n\nexport { _default as default };","map":{"version":3,"sources":["/Users/justin/Desktop/my/client-mobile/pages/chatroom.js"],"names":["Layout","api","pb","resp","readStream","moment","apiHost","socket","saytext","msgList","room","props","query","state","ReconnectingWebSocket","debug","timeoutInterval","onopen","onmessage","evt","received_msg","data","receivedMsg","receivedMsgB","ws_msg_base","deserializeBinary","getEvent","events","CHAT_CONTENT","CHAT_RECORDS","console","log","msg","chat_content","getData","msgObj","toObject","unshift","setState","setTimeout","document","documentElement","scrollTop","blog_chat_records","tempMsgList","i","blogChatRecordListList","length","item","push","createTime","format","content","getElementById","setAttribute","style","display","onclose","event","e","window","keyCode","baseMsg","setMsg","setData","serializeBinary","send","target","value","subMitComment","bind","listStyle","map","k","timeString","height","req","jsonPageRes","userAgent","headers","navigator","React","Component"],"mappings":"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","sourcesContent":["import Layout from '../components/layout';\nimport * as api from '../apis/blog';\nimport pb from \"../proto/ws_pb\";\nimport resp from \"../proto/resp_pb\";\nimport readStream from '../utils/util';\nimport moment from 'moment';\nimport {apiHost} from '../utils/config';\n\nexport default class extends React.Component {\n  static async getInitialProps({ req,query,jsonPageRes }) {\n    const userAgent = req ? req.headers['user-agent'] : navigator.userAgent\n    return { userAgent,query,jsonPageRes }\n  }\n\n  state = {\n    socket:null,\n    saytext:\"\",\n    msgList:[]\n  }\n\n  async componentDidMount(){\n    const {room} = this.props.query;\n    let {socket} = this.state;\n    socket = new ReconnectingWebSocket(`ws://${apiHost}/v1/ws/chatroom?room=${room}`);\n    socket.debug = false;\n    socket.timeoutInterval = 5400;\n    socket.onopen = function(){\n      //socket.send(\"发送数据\");\n    };\n        \n    socket.onmessage = async (evt) =>\n    { \n      let {msgList} = this.state;\n      var received_msg = evt.data;\n      let receivedMsg = await readStream(received_msg);\n      let receivedMsgB = pb.ws_msg_base.deserializeBinary(receivedMsg);\n      switch(receivedMsgB.getEvent()){\n        case pb.events.CHAT_CONTENT:\n          {\n            console.log(112)\n            let msg = pb.chat_content.deserializeBinary(receivedMsgB.getData());\n            let msgObj = msg.toObject();\n            msgList.unshift(msgObj);\n            this.setState({msgList}),()=>{\n              console.log(112)\n              setTimeout(() => {\n                document.documentElement.scrollTop = 0\n              }, 3500);\n            };\n            break\n          }\n        case pb.events.CHAT_RECORDS:\n          {\n            let msg = resp.blog_chat_records.deserializeBinary(receivedMsgB.getData());\n            let msgObj = msg.toObject();\n            let tempMsgList = [];\n            for (let i=0;i<msgObj.blogChatRecordListList.length;i++){\n              let item = msgObj.blogChatRecordListList[i];\n              tempMsgList.push({\"timeString\":moment(item.createTime).format(\"YYYY-MM-DD HH:mm:ss\"),\"msg\":item.content});\n            }\n            this.setState({msgList: tempMsgList});\n            setTimeout(()=>{\n              document.getElementById(\"t\").setAttribute(\"class\",\"shadownone\")\n              document.getElementById(\"loading\").style.display = \"none\";\n            },500)\n            break\n          }\n      }\n    };\n        \n    socket.onclose = function()\n    { \n      console.log(\"链接已关闭\")\n    };\n    this.setState({socket});\n  }\n\n  async subMitComment(event){\n    let {socket} = this.state;\n    var e = event || window.event;\n    if (e && e.keyCode == 13) { //回车键的键值为13\n      let {saytext} = this.state;\n      let baseMsg = new pb.ws_msg_base();\n      let msg = new pb.chat_content();\n      msg.setMsg(saytext);\n      baseMsg.setData(msg.serializeBinary());\n      socket.send(baseMsg.serializeBinary());\n      this.setState({saytext:\"\"},()=>{\n        setTimeout(() => {\n          document.documentElement.scrollTop = 0\n        }, 300);\n      })\n    }\n  }\n\n  render() {\n    let {saytext,msgList} = this.state;\n    return (\n      <Layout title={`聊天室`}>\n        <div>\n          <input className=\"chatcontent\" placeholder=\"聊点什么吧...\" value={saytext} onChange={(e)=>{\n            this.setState({\"saytext\":e.target.value})\n          }} onKeyUp={this.subMitComment.bind(this)} />\n          <ul style={{listStyle:\"none\"}} className=\"chatlist\">\n            {\n              msgList.map((item,k)=>(\n                <li key={k}>\n                  <span>{item.timeString}</span>\n                  <div style={{height:12}}></div>\n                  <div className=\"chatbox\">{item.msg}</div>\n                </li>\n              ))\n            }\n          </ul>\n        </div>\n        <style jsx>{`\n          .chatbox{\n            color: #333;\n            border-radius: 5px;\n          }\n          .chatlist{\n            width: 94%;\n            margin: auto;\n          }\n          .chatlist li {\n            background: #fff;\n            box-shadow: 3px 4px 4px #ccc;\n            border-radius: 5px;\n            padding: 15px;\n            margin-bottom: 20px;\n          }\n          .chatlist li span{\n            font-size: 14px;\n          }\n          .chatcontent{\n            width: 90%;\n            color: #333;\n            font-size: 18px;\n            padding: 10px 0px;\n            border: none;\n            background: none;\n            margin: auto;\n            display: block;\n          }\n          .chatcontent:hover{\n            outline: none;\n          }\n          .chatcontent:focus{\n            outline: none;\n          }\n\n        `}</style>\n      </Layout>\n    )\n\n   \n\n  }\n}\n\n\n"]},"metadata":{},"sourceType":"module"}